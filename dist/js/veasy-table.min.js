angular.module("veasyTable",["ui.bootstrap","veasyTable.templates"]).directive("veasyTable",["$window","$filter","$templateCache","$timeout","$uibModal",function(a,b,c,d,e){return{restrict:"EA",replace:!0,templateUrl:"veasy-table.html",scope:{list:"=",selectedItems:"=",config:"="},link:function(c,f,g,h){var i=function(){c.isLoading=!0,c.tableSize=0,c.minimumTableSize=400,c.query="",c.condition="AND",c.searching=!1,c.paginatedList=[],c.cbs=[],c.dragControlListeners={accept:function(a,b){return!0},itemMoved:function(a){},orderChanged:function(a){},containment:"#board"},j(),m(),c.$watch(function(){return angular.element("#"+c.config.id).width()},function(a){if(a>c.minimumTableSize){if(c.tableSize=a,c.resizing)return;d(function(){c.resizing=!1,r(angular.copy(c.config.columns),angular.copy(c.config.resizable.minimumSize))},0)}}),c.$watch(function(){return c.list},function(a){a&&a.length>0&&(angular.forEach(a,function(a,b){c.cbs[b]=!1}),c.config.pagination.enable?c.currentPage=c.config.pagination.currentPage:(c.config.pagination.itemsPerPage=a.length,c.currentPage=0),c.isLoading=!1,p(a))})},j=function(){c.config||(c.config={}),c.config.id||(c.config.id="veasy-table"),c.config.columns||(c.config.columns=[]),c.config.checkbox||(c.config.checkbox={}),c.config.checkbox.enable||(c.config.checkbox.enable=!1),c.config.checkbox.size||(c.config.checkbox.size=20),c.config.sort||(c.config.sort={}),c.config.sort.enable||(c.config.sort.enable=!1),c.config.pagination||(c.config.pagination={}),c.config.pagination.enable||(c.config.pagination.enable=!1),c.config.pagination.currentPage||(c.config.pagination.currentPage=0),c.config.pagination.itemsPerPage||(c.config.pagination.itemsPerPage=10),c.config.filter||(c.config.filter={}),c.config.filter.enable||(c.config.filter.enable=!1),c.config.filter.conditional||(c.config.filter.conditional=!1),c.config.filter.delay||(c.config.filter.delay=500),c.config.columnFilter||(c.config.columnFilter={}),c.config.columnFilter.enable||(c.config.columnFilter.enable=!1),c.config.columnFilter.autoOpen||(c.config.columnFilter.autoOpen=!1),c.config.columnFilter.modalSize||(c.config.columnFilter.modalSize="md"),c.config.resizable||(c.config.resizable={}),c.config.resizable.enable||(c.config.resizable.enable=!1),c.config.resizable.minimumSize||(c.config.resizable.minimumSize=1),c.config.events||(c.config.events={}),c.config.events.onClickRow||(c.config.events.onClickRow=void 0),c.config.events.onApplyColumnFilter||(c.config.events.onApplyColumnFilter=void 0),c.config.events.onTableStateChange||(c.config.events.onTableStateChange=void 0),c.config.translate||(c.config.translate={}),c.config.translate.filter||(c.config.translate.filter={}),c.config.translate.filter.by||(c.config.translate.filter.by="Filter by..."),c.config.translate.filter.and||(c.config.translate.filter.and="AND"),c.config.translate.filter.or||(c.config.translate.filter.or="OR"),c.config.translate.pagination||(c.config.translate.pagination={}),c.config.translate.pagination.itemsByPage||(c.config.translate.pagination.itemsByPage="Items by Page"),c.config.translate.pagination.totalItems||(c.config.translate.pagination.totalItems="Total of Items"),c.config.translate.columnFilter||(c.config.translate.columnFilter={}),c.config.translate.columnFilter.title||(c.config.translate.columnFilter.title="Which columns you want to display?"),c.config.translate.columnFilter.okButton||(c.config.translate.columnFilter.okButton="Ok"),c.config.translate.columnFilter.cancelButton||(c.config.translate.columnFilter.cancelButton="Cancel")},k={toPixel:function(a,b){return angular.forEach(a,function(a){a.size=a.size*b/100}),a},toPercentage:function(a,b){return angular.forEach(a,function(a){a.size=100*a.size/b}),a}},l=function(a){c.$apply(function(){angular.forEach(a,function(a,b){a.size=0})})},m=function(){a.addEventListener("resize",function(){c.resizing=!0;var a=G(),b=k.toPercentage(angular.copy(c.visibleColumns),a);l(c.visibleColumns),a=G(),b=k.toPixel(b,a),c.$apply(function(){c.visibleColumns=b})})};c.onClickRow=function(a){if(c.config.events.onClickRow){var b=angular.copy(a);b.$$hashKey&&delete b.$$hashKey,c.config.events.onClickRow(b)}};var n=function(a){d(function(){var b=angular.copy(c.visibleColumns);angular.forEach(b,function(a,b){a.$$hashKey&&delete a.$$hashKey}),c.config.events.onApplyColumnFilter(k.toPercentage(b,a))},0)},o=function(a){c.config.events.onTableStateChange&&(c.resizeTimer&&d.cancel(c.resizeTimer),c.resizeTimer=d(function(){c.config.events.onTableStateChange(a)},4e3))},p=function(a){c.totalOfItems=a.length,B(a)},q=function(a){c.visibleColumns=[],d(function(){s(angular.copy(a),angular.copy(c.config.resizable.minimumSize))},0)},r=function(a,b){c.config.columnFilter.autoOpen&&u(a).length<1&&c.openColumnFilter(c.config.columnFilter.modalSize),s(a,b)},s=function(a,b){t(a,b),K(c.visibleColumns.length)},t=function(a,b){c.visibleColumns=v(u(a),b)},u=function(a){return a.filter(function(a){return a.show})},v=function(a,b){var c=[],d=a.reduce(function(a,d,e,f){return d.show?d.size&&d.size>=b?(c.push(e),a+d.size):(d.size=b,a+d.size):(d.size&&delete d.size,a)},0);if(c.length<1)return x(G(),a);var e=100-d,f=c[c.length-1];return!a[f].size||a[f].size+e<b?x(G(),a):(a[f].size+=e,w(G(),a))},w=function(a,b){return angular.forEach(b,function(b){b.size=Math.round(a*b.size)/100}),angular.copy(b)},x=function(a,b){return angular.forEach(b,function(c,d){c.size=Math.round(a/b.length*100)/100}),angular.copy(b)};c.changeCondition=function(a,b){c.condition=a,c.search(a,b)},c.changeQuery=function(a,b){c.searching=!0,c.queryBusy&&d.cancel(c.queryBusy),c.queryBusy=d(function(){c.search(a,b)},c.config.filter.delay)},c.search=function(a,b){var d=y(a,b);c.totalOfItems=d.length,c.currentPage=0,p(d)};var y=function(a,d){var e=b("filter")(c.list,function(b){switch(a){case"AND":return z(b,d);case"OR":return A(b,d)}});return c.searching=!1,e},z=function(a,b){var d="";angular.forEach(c.visibleColumns,function(b){d+=" "+a[b.value]});var e=[],f=angular.lowercase(b).split(" ");return angular.forEach(f,function(a){e.push(d.toString().toLowerCase().indexOf(a)>=0)}),-1===e.indexOf(!1)},A=function(a,b){var d=angular.lowercase(b).split(" "),e=[];return angular.forEach(c.visibleColumns,function(b){var c=a[b.value]?a[b.value]:"";angular.forEach(d,function(a){e.push(c.toString().toLowerCase().indexOf(a)>=0)})}),e.indexOf(!0)>=0},B=function(a){c.paginatedList=[];for(var b=0;b<a.length;b++){var d=b/c.config.pagination.itemsPerPage;b%c.config.pagination.itemsPerPage===0?!isNaN(d)&&isFinite(d)&&(c.paginatedList[Math.floor(d)]=[a[b]]):!isNaN(d)&&isFinite(d)&&c.paginatedList[Math.floor(d)].push(a[b])}};c.pages=function(){if(c.config.pagination.enable){var a=c.currentPage,b=c.paginatedList.length-1,d=5,e=[];a>b-d&&(a=b-d+1);for(var f=a;a+d>f;f++)f>=0&&e.push(f);return e}},c.setPage=function(a){c.currentPage=a,E(c.list)},c.nextPage=function(){c.currentPage<c.paginatedList.length-1&&c.setPage(c.currentPage+1)},c.prevPage=function(){c.currentPage>0&&c.setPage(c.currentPage-1)},c.nextPageDisabled=function(){return c.currentPage==c.paginatedList.length-1?"disabled":""},c.prevPageDisabled=function(){return 0==c.currentPage?"disabled":""},c.onDragStart=function(a,b){c.initialPosition=I(a).x,c.draggableColumnIndex=b,c.dragging=!0},c.onDragStop=function(a,b){c.draggableColumnIndex=void 0,c.dragging&&o(angular.copy(b)),c.dragging=!1},c.onMove=function(a,b){if(c.dragging){var d=angular.copy(c.draggableColumnIndex),e=b[d].size,f=b[d-1].size,g=J(),h=H(a),i=I(a).x;i>c.initialPosition&&(c.direction=!0),i<c.initialPosition&&(c.direction=!1);var j=C(c.initialPosition,i,h.left);(g>e+j||g>f-j)&&(j=0),D(j,d)}};var C=function(a,b,d){c.direction=!0,a>b&&(c.direction=!1);var e=Math.abs(parseInt(a-d)),f=Math.abs(parseInt(b-d));return c.initialPosition=b,e-f},D=function(a,b){c.visibleColumns[b].size+=a,c.visibleColumns[b-1].size-=a};c.sort=function(a,d){c.config.sort.enable&&(c.predicate===a&&(c.reverse=!c.reverse),c.predicate=a,""!==c.predicate&&(d=b("orderBy")(d,c.predicate,c.reverse)),p(d))},c.orderByIcon=function(a,b){if(!c.config.sort.enable)return!1;switch(a){case"asc":return c.predicate===b&&c.reverse;case"desc":return c.predicate===b&&!c.reverse;default:return!0}},c.openColumnFilter=function(a){var b=e.open({templateUrl:"veasy-table-modal.html",controller:"ColumnFilterController",size:a,resolve:{config:function(){return c.config}}});b.result.then(function(a){var b=G();q(a,b),c.config.events.onApplyColumnFilter&&n(b)})},c.getIndex=function(a,b){return a.indexOf(b)},c.onCheckRow=function(a,b){var d=c.cbs[a];F(c.selectedItems,b)?d?(c.cbs[a]=!1,c.selectedItems.splice(c.selectedItems.indexOf(b),1)):c.selectedItems.splice(c.selectedItems.indexOf(b),1):d&&c.selectedItems.push(b)},c.checkOrUncheckAllRows=function(a,b){c.selectedItems=[],angular.forEach(c.cbs,function(a,d){c.cbs[d]=angular.copy(b)}),b&&angular.forEach(a,function(a,b){angular.forEach(a,function(a,b){c.selectedItems.push(a)})})};var E=function(a){angular.forEach(c.selectedItems,function(b,d){c.cbs[c.getIndex(a,b)]=!0})},F=function(a,b){return a.indexOf(b)>=0},G=function(){var a=angular.copy(c.tableSize);return c.config.checkbox.enable&&(a-=c.config.checkbox.size),a},H=function(a){return document.getElementById(c.config.id).getBoundingClientRect()},I=function(a){a=a||window.event;var b=a.pageX,c=a.pageY;return void 0===b&&(b=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,c=a.clientY+document.body.scrollTop+document.documentElement.scrollTop),{x:b,y:c}},J=function(){return c.config.resizable.minimumSize*G()/100};c.getCheckboxSizeInPixel=function(){return c.config.checkbox.size+"px"};var K=function(a){c.config.checkbox.enable&&(a+=1),c.colspan=a};i()}}}]).controller("ColumnFilterController",["$scope","$uibModalInstance","config",function(a,b,c){var d=function(){a.config=c,a.columns=c.columns,a.visibleColumns=e(a.columns)};a.ok=function(){b.close(e(a.columns))},a.cancel=function(){b.dismiss("cancel")};var e=function(a){var b=[];return angular.forEach(a,function(a){a.$$hashKey&&delete a.$$hashKey,a.size&&delete a.size,a.show&&b.push(a)}),b};d()}]);